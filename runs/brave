#!/usr/bin/env bash

yay -S --noconfirm --needed brave-bin
sudo pacman -S --noconfirm --needed gnome-keyring libsecret

set -euo pipefail

echo "Setting up GNOME Keyring auto-unlock..."

# 1. Configure PAM for automatic keyring unlock
PAM_FILE="/etc/pam.d/login"
if ! grep -q "pam_gnome_keyring.so" "$PAM_FILE"; then
  sudo bash -c "cat >> $PAM_FILE <<'EOF'

# Unlock GNOME Keyring on login
auth optional pam_gnome_keyring.so
session optional pam_gnome_keyring.so auto_start
EOF"
  echo " • Added keyring PAM configuration to $PAM_FILE"
else
  echo " • PAM already has keyring configuration"
fi

# 3. (Optional) Create a blank-pw keyring to skip prompts
if [ ! -f "$HOME/.local/share/keyrings/login.keyring" ]; then
  echo " • Please start Seahorse manually and set your 'login' keyring password to match your user login (or leave it blank for no prompts)."
else
  echo " • Login keyring exists; ensure its password matches your login."
fi

echo -e "\nSetup complete! Reboot or log out and back in to apply changes."
